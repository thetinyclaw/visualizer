<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyClaw Visualizer - Pulse Cube</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.8); cursor: pointer; transition: opacity 0.5s;
        }
        #text { text-align: center; }
        h1 { margin: 0 0 10px; font-weight: 300; letter-spacing: 2px; }
        p { color: #888; }
    </style>
</head>
<body>
    <div id="overlay">
        <div id="text">
            <h1>VISUALIZER</h1>
            <p>Click to start & allow microphone</p>
        </div>
    </div>
    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

        let scene, camera, renderer, cube, analyser, dataArray;
        let isRunning = false;

        function init() {
            // Scene
            scene = new THREE.Scene();

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Geometry - The "Pulse Cube"
            const geometry = new THREE.BoxGeometry(1.5, 1.5, 1.5);
            // Wireframe material for that "tech" look
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00ff88, 
                wireframe: true,
                transparent: true,
                opacity: 0.8
            });
            cube = new THREE.Mesh(geometry, material);
            scene.add(cube);

            // Responsive resize
            window.addEventListener('resize', onWindowResize, false);

            // Start loop
            animate();
        }

        async function startAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(stream);
                
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                // Hide overlay
                const overlay = document.getElementById('overlay');
                overlay.style.opacity = 0;
                setTimeout(() => overlay.remove(), 500);
                
                isRunning = true;
            } catch (err) {
                console.error('Mic access denied:', err);
                alert('Microphone access is needed for the visualizer to work!');
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            // Rotation (always active)
            cube.rotation.x += 0.01;
            cube.rotation.y += 0.01;

            if (isRunning && analyser) {
                analyser.getByteFrequencyData(dataArray);
                
                // Calculate average volume
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i];
                }
                const average = sum / dataArray.length;
                
                // Map volume to scale (Pulse)
                // Base scale 1.0, add boost based on volume
                const scale = 1.0 + (average / 50); 
                cube.scale.set(scale, scale, scale);
                
                // Dynamic color based on bass vs treble?
                // For now, simple hue shift based on volume
                const hue = (average / 255) * 0.5 + 0.3; // Greenish to Blueish
                cube.material.color.setHSL(hue, 1.0, 0.5);
            }

            renderer.render(scene, camera);
        }

        // Init scene immediately
        init();

        // Wait for click to start audio (browser policy)
        document.getElementById('overlay').addEventListener('click', startAudio);
    </script>
</body>
</html>